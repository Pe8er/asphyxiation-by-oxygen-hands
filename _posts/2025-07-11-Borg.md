---
title: I have finally set up backups on my server
date: 2025-07-11
categories:
  - Blog
tags: [Homelab]
toc: true
header:
  teaser:
---

This procedure was scary and felt like stumbling around a maze in a blindfold. Borg is way too powerful and customizable for my needs. I think it works. We'll see.

<!--more-->

## Installation

```bash
sudo apt update
sudo apt install pipx
sudo pipx ensurepath
sudo apt install borgbackup
sudo pipx install borgmatic
```

Check if it's installed:

```bash
sudo su -
borgmatic --version
```

Add /root/.local/bin to sudoers:

```bash
sudo visudo
```

Find "secure_path" line and add at the end:

```bash
:/root/.local/bin
```

## Configuration

Generate the config file:

```bash
sudo borgmatic config generate --destination ~/.config/borgmatic/config.yaml
```

I don't know why borgmatic didn't pick up on the custom `--destination`, so I had to fix it, caveman-style:

```bash
sudo mkdir /etc/borgmatic
sudo ln -s ~/.config/borgmatic/config.yaml /etc/borgmatic/config.yaml
```

Here's the excerpt of my config:

```yaml
source_directories:
    - /home/pe8er
    - /mnt/ssd-sandisk
repositories:
	label: g3-backup
	- path: /mnt/media/borgbackups
	# - path: ssh://k8pDxu32@k8pDxu32.repo.borgbase.com/./repo <HETZNER GOES HERE
	encryption: authenticated
exclude_patterns:
	- /home/pe8er/.cache
    - /home/pe8er/Downloads
    - /home/pe8er/Movies
    - /home/pe8er/TV
    - /home/pe8er/snap
    - '*/*tmp'
    - '*/log'
    - '*/*.log'
    - '*/.stversions'

encryption_passcommand: cat /home/pe8er/.secrets/borg

keep_daily: 7
keep_weekly: 4
keep_monthly: 3

ntfy:
    topic: borg
    server: http://192.168.1.199:8787
    username: NTFY-USER
    password: NTFY-PASS

    start:
        title: A borgmatic backup started
        message: Watch this spaceâ€¦
        tags: borgmatic
        priority: min
    finish:
        title: A borgmatic backup completed successfully
        message: Nice!
        tags: borgmatic,+1
        priority: min
    fail:
        title: A borgmatic backup failed
        message: You should probably fix it
        tags: borgmatic,-1,skull
        priority: max
    states:
        - start
        - finish
        - fail
```

Holy shit, the way keep_* options are designed is absolutely beyond my comprehension.

Validate config:

````bash
sudo borgmatic config validate
````

## Launch the Borg!!!

```bash
sudo borgmatic create --verbosity 1 --list --stats
```

Oh damn it works! And it's pretty damn fast.

```bash
g3-backup: Pruning archives
Keeping archive (rule: daily #1):            g3-2025-07-11T14:50:55.642919        Fri, 2025-07-11 14:50:55 [1678cb92d646bca4a8912c4479ab9d96a9f3c38f81e8a26bdbcd79dbdd2f95cd]
Pruning archive (1/1):                       g3-2025-07-11T14:49:49.867765        Fri, 2025-07-11 14:49:50 [35cef225b9c6a0bcf06fb4c228166e158f3f602f6cf6bf300dbd14fe827fdeeb]
Keeping archive (rule: daily[oldest] #2):    g3-2025-07-11T10:43:31.991167        Fri, 2025-07-11 10:43:32 [9248f2607a766f9bbb686173cdc1ae59df100cc54ec8155f16e1fffb4516e9d1]
------------------------------------------------------------------------------
                       Original size      Compressed size    Deduplicated size
Deleted data:             -738.30 GB           -715.41 GB             -4.71 MB
All archives:                1.48 TB              1.43 TB            642.51 GB
                       Unique chunks         Total chunks
Chunk index:                  364881               831003
------------------------------------------------------------------------------
g3-backup: Compacting segments
compaction freed about 4.71 MB repository space.
g3-backup: Running consistency checks
g3-backup: Skipping repository check due to configured frequency; 29 days, 22:33:44.729506 until next check (use --force to check anyway)
g3-backup: Skipping archives check due to configured frequency; 29 days, 22:33:44.728086 until next check (use --force to check anyway)

summary:
/etc/borgmatic/config.yaml: Successfully ran configuration file
```

## Automation

Download service and timer files. I ended up leaving them as is.

```bash
wget https://projects.torsion.org/borgmatic-collective/borgmatic/raw/branch/main/sample/systemd/borgmatic.service
wget https://projects.torsion.org/borgmatic-collective/borgmatic/raw/branch/main/sample/systemd/borgmatic.timer
```

Move them where they need to be and enable systemd service:

```bash
sudo mv borgmatic.service borgmatic.timer /etc/systemd/system/
sudo systemctl enable borgmatic.timer
```

Does it work?

```bash
sudo systemctl status borgmatic.timer
```

## Browsing and Restoring Files

List backups:

```bash
sudo borgmatic list
```

Export encryption key:

```bash
sudo borgmatic key export
```

Perform pruning, compaction, create backups according to your config file, and check backups for consistency:

```bash
sudo borgmatic --verbosity 1 --list --stats
```

Search for a file:

```bash
sudo borgmatic list --find foo.txt
```

[More information in borgmatic documentation.](https://torsion.org/borgmatic/docs/how-to/inspect-your-backups/)
